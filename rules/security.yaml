# SaasCode Kit — Security Rules
# Covers: XSS, SQL Injection, Secrets, Sensitive Logging, SSRF

rules:
  # --- XSS Prevention ---

  - id: dangerous-inner-html
    message: |
      dangerouslySetInnerHTML can lead to XSS attacks if used with user-controlled input.
      Use text content rendering {variable} or sanitize with DOMPurify first.
    severity: ERROR
    languages: [typescript, javascript]
    pattern: dangerouslySetInnerHTML={{__html: $INPUT}}

  # --- SQL Injection ---

  - id: raw-query-string-interpolation
    message: |
      Raw SQL query with string interpolation is vulnerable to SQL injection.
      Use parameterized queries or the ORM's built-in methods instead.
    severity: ERROR
    languages: [typescript]
    patterns:
      - pattern: $PRISMA.$queryRaw`... ${$INPUT} ...`
      - pattern-not: $PRISMA.$queryRaw(Prisma.sql`... ${$INPUT} ...`)

  - id: raw-execute-string-interpolation
    message: |
      Raw SQL execution with potential string interpolation.
      Use parameterized queries instead.
    severity: ERROR
    languages: [typescript]
    pattern: $PRISMA.$executeRaw`... ${$INPUT} ...`

  # --- Hardcoded Secrets ---

  - id: hardcoded-api-key
    message: |
      Possible hardcoded API key detected. Use environment variables instead.
      Move to .env and access via process.env.VARIABLE_NAME or ConfigService.
    severity: ERROR
    languages: [typescript, javascript]
    patterns:
      - pattern: |
          $KEY = "sk_..."
      - pattern: |
          $KEY = "pk_..."
      - pattern: |
          $KEY = "key_..."
      - pattern: |
          apiKey: "..."

  - id: hardcoded-password
    message: |
      Possible hardcoded password detected. Use environment variables instead.
    severity: ERROR
    languages: [typescript, javascript]
    pattern-regex: "(password|passwd|secret|token)\s*[:=]\s*['\"][^'\"]{8,}['\"]"

  # --- Sensitive Logging ---

  - id: logging-sensitive-data
    message: |
      Logging potentially sensitive data (token, secret, password, key).
      Never log credentials, tokens, or secrets. Use structured logging with safe fields only.
    severity: ERROR
    languages: [typescript, javascript]
    pattern-regex: "console\\.log\\(.*?(token|secret|password|apiKey|auth).*?\\)"

  - id: console-log-in-production
    message: |
      console.log found in backend code. Use a proper logger (Logger from framework) instead.
      console.log outputs are not structured and may leak sensitive information.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: console.log(...)
      - pattern-inside: |
          class $SERVICE {
            ...
          }

  # --- SSRF Prevention ---

  - id: unvalidated-url-fetch
    message: |
      HTTP request to a potentially user-controlled URL without validation.
      Validate URLs against allowlist and block internal/private IP ranges
      (localhost, 127.0.0.1, 10.*, 172.16.*, 192.168.*).
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: fetch($URL, ...)
      - pattern-not-inside: |
          if (validateUrl($URL)) { ... }

  # --- Command Injection ---

  - id: command-injection
    message: |
      Executing shell command with potentially user-controlled input.
      Never pass user input to exec/spawn. Use parameterized commands or allowlists.
    severity: ERROR
    languages: [typescript, javascript]
    patterns:
      - pattern: exec($CMD)
      - pattern: execSync($CMD)
      - pattern: spawn($CMD, ...)

  # --- Path Traversal ---

  - id: path-traversal
    message: |
      File path constructed with potentially user-controlled input.
      Validate and sanitize file paths. Use path.resolve() and verify the result
      is within expected directories.
    severity: WARNING
    languages: [typescript, javascript]
    patterns:
      - pattern: fs.readFileSync($PATH)
      - pattern: fs.writeFileSync($PATH, ...)

  # --- AI/LLM Security ---

  - id: prompt-injection-template-literal
    message: |
      User input interpolated directly into LLM prompt via template literal.
      This enables prompt injection attacks. Sanitize input and use parameterized prompt templates.
    severity: ERROR
    languages: [typescript, javascript]
    patterns:
      - pattern: |
          $PROMPT = `... ${$USER_INPUT} ...`
      - metavariable-regex:
          metavariable: $PROMPT
          regex: "(prompt|message|instruction|system)"

  - id: system-prompt-in-response
    message: |
      System prompt content may be exposed in API response.
      Never return system prompts or internal AI instructions to clients —
      this leaks business logic and enables prompt extraction attacks.
    severity: ERROR
    languages: [typescript, javascript]
    patterns:
      - pattern: |
          return { ..., systemPrompt: $VAL, ... }
      - pattern: |
          return { ..., system_prompt: $VAL, ... }

  - id: llm-output-in-eval
    message: |
      AI/LLM-generated output passed to eval(). LLM outputs are untrusted —
      an attacker could craft inputs that make the LLM produce executable code.
      Never eval() LLM output.
    severity: ERROR
    languages: [typescript, javascript]
    pattern: eval($LLM_OUTPUT)

  - id: llm-output-in-innerhtml
    message: |
      AI-generated content rendered via dangerouslySetInnerHTML.
      LLM outputs may contain malicious HTML/JS (XSS via prompt injection).
      Sanitize with DOMPurify or render as plain text.
    severity: ERROR
    languages: [typescript, javascript]
    pattern: dangerouslySetInnerHTML={{__html: $LLM_OUTPUT}}

  - id: ai-endpoint-no-rate-limit
    message: |
      AI/LLM endpoint handler without rate limiting decorator.
      AI endpoints are expensive and abuse-prone — add @Throttle() or rate limiting middleware
      to prevent cost abuse and denial-of-service.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: |
          @$METHOD($PATH)
          async $FUNC(...) {
            ...
            $AI_CLIENT.$CALL(...)
            ...
          }
      - pattern-not-inside: |
          @Throttle(...)
          ...
      - metavariable-regex:
          metavariable: $CALL
          regex: "(generate|complete|chat|create|embed)"

  - id: pii-sent-to-ai-provider
    message: |
      Sensitive user data (email, phone, ssn) may be sent to external AI provider.
      Filter PII before sending to third-party AI APIs to comply with privacy regulations
      and prevent data leaks.
    severity: WARNING
    languages: [typescript]
    pattern-regex: "(openai|anthropic|groq|replicate).*\\.(create|generate|complete|chat)\\(.*?(email|phone|ssn|password|creditCard)"

  # --- AI/GenAI Development Quality ---

  - id: ai-call-no-error-handling
    message: |
      AI provider API call without error handling. LLM API calls can fail due to
      rate limits, network issues, model overload, or content filtering.
      Always wrap AI calls in try/catch with appropriate fallback behavior.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: |
          await $CLIENT.chat.completions.create(...)
      - pattern-not-inside: |
          try { ... } catch (...) { ... }

  - id: ai-call-no-timeout
    message: |
      AI API call without timeout configuration. LLM calls can take 30+ seconds.
      Set a timeout to prevent hanging requests and poor user experience.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: |
          $CLIENT.chat.completions.create({..., })
      - pattern-not: |
          $CLIENT.chat.completions.create({..., timeout: $T, ...})
      - pattern-not: |
          $CLIENT.chat.completions.create({..., signal: $S, ...})

  - id: hardcoded-ai-model-name
    message: |
      Hardcoded AI model name. Use environment variables or configuration constants
      so model upgrades don't require code changes across the codebase.
    severity: WARNING
    languages: [typescript, javascript]
    pattern-regex: "model:\\s*['\"](?:gpt-4|gpt-3\\.5|claude-3|claude-2|gemini|llama)[^'\"]*['\"]"

  - id: streaming-no-error-handler
    message: |
      AI streaming response without error event handler.
      Streaming connections can drop — handle 'error' and 'end' events
      to prevent memory leaks and stuck requests.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: |
          $STREAM = await $CLIENT.chat.completions.create({..., stream: true, ...})
      - pattern-not-inside: |
          ... $STREAM.on('error', ...) ...

  # --- Webhook Security ---

  - id: webhook-without-signature-check
    message: |
      Webhook handler processes data without signature verification.
      Always verify webhook signatures BEFORE processing the payload.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: |
          @Post('webhook...')
          async $FUNC($REQ) {
            const $DATA = $REQ.body;
            ...
          }
      - pattern-not-inside: |
          ... verifySignature ...
