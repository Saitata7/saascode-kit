# SaasCode Kit â€” Tenant Isolation Rules
# For multi-tenant SaaS with row-level isolation
# Identifier field configured in manifest.yaml (default: tenantId)

rules:
  # CRITICAL: findMany without tenant scoping returns ALL tenants' data
  - id: unscoped-find-many
    message: |
      CRITICAL: findMany() called without tenant scoping. This returns ALL tenants' data.
      Fix: Add { where: { tenantId } } to scope the query.
    severity: ERROR
    languages: [typescript]
    patterns:
      - pattern: $PRISMA.$MODEL.findMany()
      - pattern-inside: |
          class $SERVICE {
            ...
          }

  # CRITICAL: findMany with where but missing tenantId
  - id: find-many-missing-tenant-id
    message: |
      findMany() has a where clause but may be missing tenantId scoping.
      Verify that tenantId is included in the where condition.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: $PRISMA.$MODEL.findMany({ where: { ... } })
      - pattern-not: $PRISMA.$MODEL.findMany({ where: { ..., tenantId: $ID, ... } })
      - pattern-inside: |
          class $SERVICE {
            ...
          }

  # WARNING: findUnique without ownership verification
  - id: find-unique-no-ownership-check
    message: |
      findUnique/findFirst should be followed by an ownership check.
      After fetching a record, verify record.tenantId === tenantId to prevent cross-tenant access.
    severity: WARNING
    languages: [typescript]
    pattern: |
      const $RECORD = await $PRISMA.$MODEL.findUnique({ where: { id: $ID } });
      return $RECORD;

  # CRITICAL: deleteMany without tenant scoping
  - id: unscoped-delete
    message: |
      CRITICAL: delete/deleteMany without tenant scoping. Could delete other tenants' data.
      Fix: Include tenantId in the where clause.
    severity: ERROR
    languages: [typescript]
    patterns:
      - pattern: $PRISMA.$MODEL.deleteMany()
      - pattern-inside: |
          class $SERVICE {
            ...
          }

  # CRITICAL: updateMany without tenant scoping
  - id: unscoped-update
    message: |
      CRITICAL: updateMany without tenant scoping. Could modify other tenants' data.
      Fix: Include tenantId in the where clause.
    severity: ERROR
    languages: [typescript]
    patterns:
      - pattern: $PRISMA.$MODEL.updateMany({ where: { ... }, data: { ... } })
      - pattern-not: $PRISMA.$MODEL.updateMany({ where: { ..., tenantId: $ID, ... }, data: { ... } })
