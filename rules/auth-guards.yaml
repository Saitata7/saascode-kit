# SaasCode Kit â€” Auth Guard Rules
# Framework: NestJS (decorator-based)
# Adapt patterns section for Express/Fastify middleware-based auth

rules:
  # CRITICAL: @Roles without RolesGuard means roles are silently ignored
  - id: roles-without-roles-guard
    message: |
      CRITICAL: @Roles() decorator found without RolesGuard in @UseGuards().
      Roles are SILENTLY IGNORED without RolesGuard. Any authenticated user can access this endpoint.
      Fix: Add RolesGuard to @UseGuards(AuthGuard, TenantGuard, RolesGuard)
    severity: ERROR
    languages: [typescript]
    patterns:
      - pattern: |
          @Roles(...)
          $FUNC(...) { ... }
      - pattern-not-inside: |
          @UseGuards(..., RolesGuard, ...)
          ...
          @Roles(...)
          $FUNC(...) { ... }

  # CRITICAL: Controller without any guards
  - id: controller-without-guards
    message: |
      Controller has no @UseGuards() decorator. All endpoints are unprotected.
      Fix: Add @UseGuards(AuthGuard, TenantGuard, RolesGuard) at controller or method level.
    severity: ERROR
    languages: [typescript]
    patterns:
      - pattern: |
          @Controller(...)
          class $CLASS {
            @$METHOD(...)
            $FUNC(...) { ... }
          }
      - pattern-not-inside: |
          @UseGuards(...)
          ...

  # WARNING: Route handler without Roles decorator
  - id: endpoint-without-roles
    message: |
      Endpoint has guards but no @Roles() decorator. Any authenticated user of the tenant can access it.
      This may be intentional (all roles allowed) but verify it matches business requirements.
    severity: WARNING
    languages: [typescript]
    patterns:
      - pattern: |
          @$HTTP_METHOD(...)
          $FUNC(...) { ... }
      - pattern-inside: |
          @UseGuards(..., RolesGuard, ...)
          ...
      - pattern-not-inside: |
          @Roles(...)
          ...
          @$HTTP_METHOD(...)
          $FUNC(...) { ... }

  # WARNING: Dynamic route before static route (NestJS route matching)
  - id: dynamic-before-static-route
    message: |
      Dynamic route @Get(':id') may catch static routes defined after it.
      Static routes like @Get('stats') must come BEFORE @Get(':id') in the controller.
    severity: WARNING
    languages: [typescript]
    pattern: |
      @Get(':$PARAM')
      $FUNC1(...) { ... }
      ...
      @Get('$STATIC')
      $FUNC2(...) { ... }
