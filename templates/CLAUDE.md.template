# {{project.name}} — Project Context

> Auto-generated by SaasCode Kit from manifest.yaml
> Last updated: {{generated_date}}

## Project

{{project.name}} is a {{project.type}} application for {{project.domain}}.
{{project.description}}

## Tech Stack

- **Frontend**: {{stack.frontend.framework}} {{stack.frontend.version}}, {{stack.language}}, {{stack.frontend.css}}, {{stack.frontend.ui_library}}
- **Backend**: {{stack.backend.framework}} {{stack.backend.version}}, {{stack.backend.orm}}, {{stack.backend.database}}
- **Auth**: {{auth.provider}}{{#if auth.multi_tenant}} (multi-tenant){{/if}}
- **Billing**: {{#if billing.enabled}}{{billing.provider}} ({{billing.model}}){{else}}None{{/if}}
{{#if ai.enabled}}- **AI**: {{ai.providers}} ({{ai.features}}){{/if}}
- **Cache**: {{stack.backend.cache}}
- **Infra**: {{infra.frontend_host}} (frontend), {{infra.backend_host}} (backend)

## Project Structure

```
{{paths.backend}}/                    # Backend ({{stack.backend.framework}})
  src/
    modules/[feature]/                # Feature modules
  {{schema_relative_path}}            # Database schema

{{paths.frontend}}/                   # Frontend ({{stack.frontend.framework}})
  src/
    app/                              # Pages/routes
    components/                       # UI components
    lib/api/                          # API client functions

{{#if paths.shared}}{{paths.shared}}/  # Shared types{{/if}}
```

## Authentication & Roles

Provider: {{auth.provider}}
Guard pattern: {{auth.guard_pattern}}

{{#each auth.roles}}
- **{{this.name}}**: {{this.level}}
{{/each}}

{{#if_eq auth.guard_pattern "decorator"}}
### Guard Chain

**Tenant endpoints** — ALL guards required:
```typescript
@UseGuards(AuthGuard, TenantGuard, RolesGuard)
@Roles(Role.OWNER, Role.ADMIN)
```

**CRITICAL BUG**: @Roles() without RolesGuard = ROLE NOT ENFORCED
```typescript
// WRONG — roles decorator is IGNORED without RolesGuard:
@UseGuards(AuthGuard, TenantGuard)
@Roles(Role.OWNER)  // THIS DOES NOTHING!
```

**Admin/Platform endpoints**:
```typescript
@UseGuards(AuthGuard, PlatformRolesGuard)
@PlatformRoles(PlatformRole.SUPER_ADMIN)
```
{{/if_eq}}

{{#if_eq auth.guard_pattern "middleware"}}
### Middleware Chain

**Tenant endpoints** — ALL middleware required:
```typescript
router.use(authenticate, resolveTenant, checkRole('OWNER'));
```

**CRITICAL BUG**: Missing tenant middleware = cross-tenant data access
{{/if_eq}}

{{#if tenancy.enabled}}
## Multi-Tenancy

Isolation: {{tenancy.isolation}}
Identifier: `{{tenancy.identifier}}`
Context: {{tenancy.context_source}}

### Tenant Isolation Rules

**ALWAYS** scope queries by `{{tenancy.identifier}}`:
```
findMany({ where: { {{tenancy.identifier}} } })
```

**ALWAYS** verify ownership after findUnique:
```
const record = await find({ where: { id } });
if (!record || record.{{tenancy.identifier}} !== {{tenancy.identifier}}) throw NotFound;
```

**NEVER** return unscoped queries — this leaks data across tenants.
{{/if}}

## Build Order

When building a new feature, ALWAYS follow this order:

```
1. Database Schema  → {{paths.schema}}
2. Backend DTOs     → {{paths.backend}}/src/modules/[feature]/dto/
3. Backend Service  → {{paths.backend}}/src/modules/[feature]/[feature].service.ts
4. Backend Controller → {{paths.backend}}/src/modules/[feature]/[feature].controller.ts
5. Backend Module   → {{paths.backend}}/src/modules/[feature]/[feature].module.ts
6. Frontend API Client → {{paths.api_client}}/[feature].ts
7. Frontend Components → {{paths.components}}/[feature]/
8. Frontend Pages   → {{paths.frontend}}/src/app/[feature]/
```

## API Design

Response format: `{ success, data, error, message }`
HTTP methods: GET (read), POST (create), PATCH (update), DELETE (remove)

### Endpoint Parity Rule

Every frontend API call MUST have a matching backend endpoint:
```
apiClient.post('/endpoint')  →  @Post('endpoint') in controller
```
Frontend call without backend endpoint = 404 at runtime.

{{#if billing.enabled}}
## Billing

Provider: {{billing.provider}}
Model: {{billing.model}}
{{#if billing.webhooks}}
Webhooks: Verify signature BEFORE processing. Implement idempotency.
{{/if}}
{{/if}}

{{#if ai.enabled}}
## AI Features

Providers: {{ai.providers}}
Features: {{ai.features}}

Security:
- Validate/sanitize inputs BEFORE sending to LLM
- Block prompt injection patterns
- Scan outputs for PII before returning
- Rate limit per user and per tenant
- Never expose system prompts in responses
{{/if}}

## Critical Patterns

{{#each patterns.critical}}
### {{this.id}}
{{this.description}}
- CORRECT: `{{this.correct}}`
- WRONG: `{{this.wrong}}`
{{/each}}

## Anti-Patterns (NEVER DO)

{{#each patterns.anti_patterns}}
- {{this}}
{{/each}}

{{#if patterns.colors}}
## Color System

- Tenant UI: `{{patterns.colors.tenant_ui}}`
- Admin UI: `{{patterns.colors.admin_ui}}`
{{#if patterns.colors.forbidden_in_tenant}}- NEVER in tenant UI: {{patterns.colors.forbidden_in_tenant}}{{/if}}
{{/if}}

## Verification Commands

After any feature, run ALL:
```bash
# Build
npm run typecheck
npm --prefix {{paths.backend}} run build
npm --prefix {{paths.frontend}} run build

# Endpoint parity
grep -E "apiClient\.(get|post|patch|delete)" {{paths.api_client}}/*.ts
grep -E "@(Get|Post|Patch|Put|Delete)" {{paths.backend}}/src/modules/*/*.controller.ts
```

## Do NOT

- Invent features not requested
- Change auth/billing without asking
- Skip {{tenancy.identifier}} scoping on tenant data
- Create frontend API calls without backend endpoints
- Mix admin/tenant UI contexts
- Hardcode secrets — use environment variables
- Use console.log in production code
