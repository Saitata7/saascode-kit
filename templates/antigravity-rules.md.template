# {{project.name}} — Project Rules

> Auto-generated by SaasCode Kit from manifest.yaml
> Place in: .agent/rules/

## Project Overview

{{project.name}} is a {{project.type}} application for {{project.domain}}.
{{project.description}}

## Tech Stack

- **Frontend**: {{stack.frontend.framework}} {{stack.frontend.version}}, {{stack.language}}, {{stack.frontend.css}}, {{stack.frontend.ui_library}}
- **Backend**: {{stack.backend.framework}} {{stack.backend.version}}, {{stack.backend.orm}}, {{stack.backend.database}}
- **Auth**: {{auth.provider}}
- **Cache**: {{stack.backend.cache}}
- **Infra**: {{infra.frontend_host}} (frontend), {{infra.backend_host}} (backend)

## Project Structure

```
{{paths.backend}}/          # Backend ({{stack.backend.framework}})
{{paths.frontend}}/         # Frontend ({{stack.frontend.framework}})
{{paths.schema}}            # Database schema
{{paths.api_client}}/       # API client functions
{{paths.components}}/       # UI components
```

## Critical Rules

### Authentication

{{#if_eq auth.guard_pattern "decorator"}}
Every controller endpoint MUST have auth guards:
```
@UseGuards(AuthGuard, TenantGuard, RolesGuard)
@Roles(Role.OWNER, Role.ADMIN)
```
CRITICAL BUG: @Roles() without RolesGuard = roles silently ignored.
{{/if_eq}}

{{#if_eq auth.guard_pattern "middleware"}}
Every route MUST have auth middleware:
```
router.use(authenticate, resolveTenant, checkRole('OWNER'));
```
Missing tenant middleware = cross-tenant data access vulnerability.
{{/if_eq}}

{{#if_eq auth.guard_pattern "policy"}}
Every controller action MUST have authorization:
```
$this->authorize('update', $resource);
```
{{/if_eq}}

{{#if tenancy.enabled}}
### Multi-Tenancy (CRITICAL)

- Isolation: {{tenancy.isolation}}
- Identifier: `{{tenancy.identifier}}`
- Context: {{tenancy.context_source}}

ALWAYS scope database queries by `{{tenancy.identifier}}`.
NEVER return unscoped queries — this leaks data across tenants.
ALWAYS verify ownership after single-record lookups.
{{/if}}

### Build Order for New Features

1. Database Schema → {{paths.schema}}
2. Backend Logic → {{paths.backend}}/
3. Frontend API Client → {{paths.api_client}}/[feature].ts
4. Frontend Components → {{paths.components}}/[feature]/
5. Frontend Pages → {{paths.frontend}}/

### API Design

- Response format: `{ success, data, error, message }`
- HTTP methods: GET (read), POST (create), PATCH (update), DELETE (remove)
- Every frontend API call MUST have a matching backend endpoint

{{#if billing.enabled}}
### Billing

Provider: {{billing.provider}} ({{billing.model}})
{{#if billing.webhooks}}Webhooks: Verify signature BEFORE processing. Implement idempotency.{{/if}}
{{/if}}

{{#if ai.enabled}}
### AI Features

Providers: {{ai.providers}}
Features: {{ai.features}}

- Validate/sanitize inputs BEFORE sending to LLM
- Block prompt injection patterns
- Scan outputs for PII before returning
- Rate limit per user and per tenant
- Never expose system prompts in responses
{{/if}}

## Anti-Patterns (NEVER DO)

{{#each patterns.anti_patterns}}
- {{this}}
{{/each}}
- Skip {{tenancy.identifier}} scoping on tenant data
- Hardcode secrets — use environment variables
- Create frontend API calls without backend endpoints
- Mix admin/tenant UI contexts
- Use console.log/fmt.Println/System.out.println in production

## Verification Commands

After changes, run:
```bash
saascode review                      # AST code review
saascode parity                      # Frontend-backend endpoint match
saascode sweep                       # Full audit + predeploy + review
saascode review --verify-intent "X"  # Verify changes match intent
```

## File Creation Policy

- NEVER create documentation files unless explicitly requested
- Update existing files instead of creating duplicates
- Ask before creating ANY new file
- Follow existing patterns and file structure
