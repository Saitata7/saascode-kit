#!/bin/sh
# SaasCode Kit â€” Pre-Commit Hook
# Checks: secrets, .env files, security vulnerabilities, debug statements, large files, merge conflicts
# Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ðŸ” SaasCode Pre-Commit Check"
echo "================================"

FAILED=0
STAGED_FILES=$(git diff --cached --diff-filter=ACM --name-only)

# Exit early if nothing staged
if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}Nothing staged. Skipping checks.${NC}"
  exit 0
fi

# â”€â”€â”€ 1. Hardcoded Secrets â”€â”€â”€
echo "\n${YELLOW}[1/7] Checking for hardcoded secrets...${NC}"
SECRETS=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx|py|rb|go|java|json|yaml|yml)$' | xargs grep -lE '(password|secret|api[_-]?key|token|private[_-]?key)\s*[:=]\s*["\x27][^"\x27]{8,}["\x27]' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.\|\.d\.ts\|interface\|type \|\.example\|\.sample')

if [ -n "$SECRETS" ]; then
  echo "${RED}BLOCKED: Possible hardcoded secrets detected:${NC}"
  echo "$SECRETS"
  FAILED=1
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ 2. .env Files â”€â”€â”€
echo "\n${YELLOW}[2/7] Checking for .env files...${NC}"
ENV_FILES=$(git diff --cached --name-only | grep -E '\.env($|\.local|\.prod|\.staging|\.development)')

if [ -n "$ENV_FILES" ]; then
  echo "${RED}BLOCKED: Environment files staged for commit:${NC}"
  echo "$ENV_FILES"
  echo "Add these to .gitignore"
  FAILED=1
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ 3. Security Vulnerabilities â”€â”€â”€
echo "\n${YELLOW}[3/7] Checking for security vulnerabilities...${NC}"
SECURITY_ISSUES=""

# eval() usage (code injection risk)
EVAL_USAGE=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -nE '\beval\s*\(' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.')
if [ -n "$EVAL_USAGE" ]; then
  SECURITY_ISSUES="${SECURITY_ISSUES}\n  ${RED}eval() usage (code injection risk):${NC}\n${EVAL_USAGE}"
fi

# dangerouslySetInnerHTML (XSS risk)
XSS_USAGE=$(echo "$STAGED_FILES" | grep -E '\.(tsx|jsx)$' | xargs grep -nE 'dangerouslySetInnerHTML' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.')
if [ -n "$XSS_USAGE" ]; then
  SECURITY_ISSUES="${SECURITY_ISSUES}\n  ${RED}dangerouslySetInnerHTML (XSS risk):${NC}\n${XSS_USAGE}"
fi

# SQL injection patterns (raw queries with interpolation)
SQL_INJECTION=$(echo "$STAGED_FILES" | grep -E '\.(ts|js)$' | xargs grep -nE '\$queryRaw`.*\$\{|\$executeRaw`.*\$\{|\.query\(`.*\$\{' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.\|Prisma\.sql')
if [ -n "$SQL_INJECTION" ]; then
  SECURITY_ISSUES="${SECURITY_ISSUES}\n  ${RED}Raw SQL with interpolation (injection risk):${NC}\n${SQL_INJECTION}"
fi

# Disabled security (CORS *, no-verify, --insecure)
DISABLED_SECURITY=$(echo "$STAGED_FILES" | grep -E '\.(ts|js|json|yaml|yml)$' | xargs grep -nE "origin:\s*['\"]?\*['\"]?|--no-verify|--insecure|rejectUnauthorized:\s*false|NODE_TLS_REJECT_UNAUTHORIZED" 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.')
if [ -n "$DISABLED_SECURITY" ]; then
  SECURITY_ISSUES="${SECURITY_ISSUES}\n  ${YELLOW}Disabled security check:${NC}\n${DISABLED_SECURITY}"
fi

# Sensitive data in URLs (tokens/keys in query params)
URL_SECRETS=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -nE 'https?://[^"'\'']*[?&](token|key|secret|password|api_key)=' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.\|\.example')
if [ -n "$URL_SECRETS" ]; then
  SECURITY_ISSUES="${SECURITY_ISSUES}\n  ${RED}Secrets in URL query params:${NC}\n${URL_SECRETS}"
fi

if [ -n "$SECURITY_ISSUES" ]; then
  echo "${RED}BLOCKED: Security vulnerabilities found:${NC}"
  echo "$SECURITY_ISSUES"
  FAILED=1
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ 4. Debug Statements â”€â”€â”€
echo "\n${YELLOW}[4/7] Checking for debug statements...${NC}"
DEBUG=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -nE '(console\.(log|debug|warn)\(|debugger;)' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.' | head -10)

if [ -n "$DEBUG" ]; then
  echo "${YELLOW}WARNING: Debug statements found (not blocking):${NC}"
  echo "$DEBUG"
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ 5. Sensitive Data Logging â”€â”€â”€
echo "\n${YELLOW}[5/7] Checking for sensitive data in logs...${NC}"
SENSITIVE_LOGS=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -nE 'console\.(log|info|warn|error|debug)\(.*\b(password|token|secret|apiKey|auth_token|cookie|session|credit.?card)\b' 2>/dev/null | grep -v 'node_modules\|\.test\.\|\.spec\.')

if [ -n "$SENSITIVE_LOGS" ]; then
  echo "${RED}BLOCKED: Sensitive data in log statements:${NC}"
  echo "$SENSITIVE_LOGS"
  FAILED=1
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ 6. Large Files â”€â”€â”€
echo "\n${YELLOW}[6/7] Checking for large files...${NC}"
LARGE_FILES=$(git diff --cached --name-only | while read FILE; do
  if [ -f "$FILE" ]; then
    SIZE=$(wc -c < "$FILE" 2>/dev/null)
    if [ "$SIZE" -gt 1048576 ] 2>/dev/null; then
      echo "$FILE ($(echo "scale=1; $SIZE/1048576" | bc)MB)"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo "${RED}BLOCKED: Files larger than 1MB:${NC}"
  echo "$LARGE_FILES"
  FAILED=1
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ 7. Merge Conflict Markers â”€â”€â”€
echo "\n${YELLOW}[7/7] Checking for merge conflict markers...${NC}"
CONFLICTS=$(echo "$STAGED_FILES" | xargs grep -lE '^(<<<<<<<|=======|>>>>>>>)' 2>/dev/null)

if [ -n "$CONFLICTS" ]; then
  echo "${RED}BLOCKED: Merge conflict markers found:${NC}"
  echo "$CONFLICTS"
  FAILED=1
else
  echo "${GREEN}PASS${NC}"
fi

# â”€â”€â”€ Result â”€â”€â”€
echo "\n================================"
if [ $FAILED -ne 0 ]; then
  echo "${RED}Pre-commit check FAILED. Fix issues above before committing.${NC}"
  echo "To bypass (not recommended): git commit --no-verify"
  exit 1
else
  echo "${GREEN}All pre-commit checks passed.${NC}"
  exit 0
fi
